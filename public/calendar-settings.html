<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Calendar連携 - サポ田さん</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .status-connected {
            color: #28a745;
        }
        .status-disconnected {
            color: #6c757d;
        }
        .calendar-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-calendar3"></i> Google Calendar連携
            </span>
            <a href="index.html" class="btn btn-light btn-sm">
                <i class="bi bi-house"></i> ダッシュボードに戻る
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- 使い方説明 -->
        <div class="alert alert-info" role="alert">
            <h5 class="alert-heading"><i class="bi bi-info-circle"></i> Google Calendar連携について</h5>
            <p>Googleカレンダーとサポ田さんのGoogle Calendarを連携すると、担当タスクが自動的にあなたのGoogleカレンダーに追加されます。</p>
            <hr>
            <p class="mb-0">
                <strong>機能：</strong><br>
                • 期限のあるタスクを自動的にカレンダーイベントとして作成<br>
                • タスクの優先度に応じて色分け表示<br>
                • タスク完了時にイベントを自動更新
            </p>
        </div>

        <!-- 連携状態カード -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> 連携状態</h5>
            </div>
            <div class="card-body">
                <!-- ローディング -->
                <div id="loading" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                    <p class="mt-2">連携状態を確認中...</p>
                </div>

                <!-- 未連携状態 -->
                <div id="disconnectedState" style="display: none;" class="text-center py-4">
                    <i class="bi bi-calendar-x calendar-icon status-disconnected"></i>
                    <h4>Google Calendarと連携していません</h4>
                    <p class="text-muted">連携することで、タスクが自動的にあなたのカレンダーに追加されます。</p>
                    <button id="connectBtn" class="btn btn-primary btn-lg mt-3" onclick="connectGoogleCalendar()">
                        <i class="bi bi-google"></i> Googleカレンダーと連携する
                    </button>
                </div>

                <!-- 連携済み状態 -->
                <div id="connectedState" style="display: none;" class="text-center py-4">
                    <i class="bi bi-calendar-check calendar-icon status-connected"></i>
                    <h4 class="status-connected">Google Calendarと連携中</h4>
                    <p class="text-muted">タスクは自動的にあなたのGoogleカレンダーに同期されます。</p>
                    <div class="alert alert-success mt-3" role="alert">
                        <i class="bi bi-check-circle"></i> 連携完了！担当タスクがカレンダーに反映されています。
                    </div>
                    <button class="btn btn-danger mt-3" onclick="disconnectGoogleCalendar()">
                        <i class="bi bi-x-circle"></i> 連携を解除する
                    </button>
                </div>

                <!-- エラー状態 -->
                <div id="errorState" style="display: none;" class="text-center py-4">
                    <i class="bi bi-exclamation-triangle calendar-icon text-warning"></i>
                    <h4>エラーが発生しました</h4>
                    <p class="text-muted" id="errorMessage">連携状態の確認に失敗しました。</p>
                    <button class="btn btn-primary mt-3" onclick="checkConnectionStatus()">
                        <i class="bi bi-arrow-clockwise"></i> 再試行
                    </button>
                </div>
            </div>
        </div>

        <!-- 注意事項 -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-shield-check"></i> プライバシーとセキュリティ</h6>
            </div>
            <div class="card-body">
                <ul class="mb-0">
                    <li>Googleアカウントの認証は安全なOAuth 2.0を使用しています</li>
                    <li>サポ田さんはカレンダーの読み書き権限のみ要求します</li>
                    <li>連携を解除すると、保存されたトークンは完全に削除されます</li>
                    <li>既にカレンダーに作成されたイベントは連携解除後も残ります</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 環境に応じてAPI URLを自動設定
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : 'https://sapot-san-bot-production.up.railway.app/api';

        // ページ読み込み時
        document.addEventListener('DOMContentLoaded', () => {
            checkConnectionStatus();
        });

        // 連携状態を確認
        async function checkConnectionStatus() {
            try {
                // ローディング表示
                showState('loading');

                // 認証情報取得（authTokenを確認）
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    showError('ログインしてください');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                // ユーザー情報を取得
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const result = await response.json();

                if (!result.success) {
                    showError('認証エラー：再度ログインしてください');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }

                const slackUserId = result.data.slack_user_id;

                // 連携状態を確認
                const statusResponse = await fetch(`${API_URL}/google-calendar/status?slack_user_id=${slackUserId}`);
                const statusResult = await statusResponse.json();

                if (statusResult.success) {
                    if (statusResult.connected) {
                        showState('connected');
                    } else {
                        showState('disconnected');
                    }
                } else {
                    showError(statusResult.error || '連携状態の確認に失敗しました');
                }

            } catch (error) {
                console.error('連携状態確認エラー:', error);
                showError('ネットワークエラーが発生しました');
            }
        }

        // Google Calendarと連携
        async function connectGoogleCalendar() {
            try {
                // 認証情報取得
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    alert('ログインしてください');
                    window.location.href = 'login.html';
                    return;
                }

                // ユーザー情報を取得
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const result = await response.json();

                if (!result.success) {
                    alert('認証エラー：再度ログインしてください');
                    window.location.href = 'login.html';
                    return;
                }

                const slackUserId = result.data.slack_user_id;

                // OAuth認証URLを開く
                const authUrl = `${API_URL}/google-calendar/auth?slack_user_id=${slackUserId}`;

                // 新しいウィンドウで認証開始
                const authWindow = window.open(
                    authUrl,
                    'GoogleCalendarAuth',
                    'width=600,height=700,resizable=yes,scrollbars=yes'
                );

                if (!authWindow) {
                    alert('ポップアップがブロックされました。ポップアップを許可してください。');
                    return;
                }

                // 認証完了を待つ（5秒ごとにチェック）
                const checkInterval = setInterval(() => {
                    if (authWindow.closed) {
                        clearInterval(checkInterval);
                        // 認証ウィンドウが閉じられたら状態を再確認
                        setTimeout(() => {
                            checkConnectionStatus();
                        }, 1000);
                    }
                }, 1000);

            } catch (error) {
                console.error('連携エラー:', error);
                alert('連携処理中にエラーが発生しました');
            }
        }

        // Google Calendar連携を解除
        async function disconnectGoogleCalendar() {
            if (!confirm('Google Calendar連携を解除しますか？\n\n既にカレンダーに作成されたイベントは残りますが、今後のタスクは同期されなくなります。')) {
                return;
            }

            try {
                // 認証情報取得
                const authToken = localStorage.getItem('authToken');
                if (!authToken) {
                    alert('ログインしてください');
                    return;
                }

                // ユーザー情報を取得
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                const result = await response.json();

                if (!result.success) {
                    alert('認証エラー：再度ログインしてください');
                    return;
                }

                const slackUserId = result.data.slack_user_id;

                // 連携解除リクエスト
                const disconnectResponse = await fetch(`${API_URL}/google-calendar/disconnect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        slack_user_id: slackUserId
                    })
                });

                const disconnectResult = await disconnectResponse.json();

                if (disconnectResult.success) {
                    alert('Google Calendar連携を解除しました');
                    checkConnectionStatus();
                } else {
                    alert(`エラー: ${disconnectResult.error}`);
                }

            } catch (error) {
                console.error('連携解除エラー:', error);
                alert('連携解除中にエラーが発生しました');
            }
        }

        // 状態表示を切り替え
        function showState(state) {
            // すべて非表示
            document.getElementById('loading').style.display = 'none';
            document.getElementById('disconnectedState').style.display = 'none';
            document.getElementById('connectedState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';

            // 指定された状態のみ表示
            switch (state) {
                case 'loading':
                    document.getElementById('loading').style.display = 'block';
                    break;
                case 'disconnected':
                    document.getElementById('disconnectedState').style.display = 'block';
                    break;
                case 'connected':
                    document.getElementById('connectedState').style.display = 'block';
                    break;
                case 'error':
                    document.getElementById('errorState').style.display = 'block';
                    break;
            }
        }

        // エラーを表示
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            showState('error');
        }
    </script>
</body>
</html>
