<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カレンダー設定 - サポ田さん</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-primary mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-calendar3"></i> カレンダー設定
            </span>
            <a href="index.html" class="btn btn-light btn-sm">
                <i class="bi bi-house"></i> ダッシュボードに戻る
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- 使い方説明 -->
        <div class="alert alert-info" role="alert">
            <h5 class="alert-heading"><i class="bi bi-info-circle"></i> カレンダー連携の使い方</h5>
            <p>各ユーザーのSlack User IDとGoogle CalendarのメールアドレスをOK紐付けることで、タスクが自動的に個人のカレンダーに反映されます。</p>
            <hr>
            <p class="mb-0">
                <strong>手順：</strong><br>
                1. 自分のGoogle Calendarを開く<br>
                2. カレンダーの「設定と共有」から「特定のユーザーとの共有」セクションに進む<br>
                3. Service Account（<code id="service-account-email">sapota-san@slack-sapota.iam.gserviceaccount.com</code>）を追加<br>
                4. 権限を「予定の変更権限」に設定<br>
                5. 下のフォームでSlack User IDとカレンダーのメールアドレスを登録
            </p>
        </div>

        <!-- 新規登録フォーム -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-plus-circle"></i> 新しいユーザーを登録</h5>
            </div>
            <div class="card-body">
                <form id="addUserForm">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="slackUserId" class="form-label">Slack User ID <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="slackUserId" placeholder="U07M3H4RYK1" required>
                            <small class="form-text text-muted">例: U07M3H4RYK1</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="calendarId" class="form-label">カレンダーID (Gmail) <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="calendarId" placeholder="example@gmail.com" required>
                            <small class="form-text text-muted">例: yamamotoikki@forestdali.biz</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="displayName" class="form-label">表示名</label>
                            <input type="text" class="form-control" id="displayName" placeholder="山本 一気">
                            <small class="form-text text-muted">任意</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-save"></i> 登録
                    </button>
                </form>
            </div>
        </div>

        <!-- 登録済みユーザー一覧 -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-people"></i> 登録済みユーザー</h5>
            </div>
            <div class="card-body">
                <div id="loading" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">読み込み中...</span>
                    </div>
                </div>
                <div id="userList" style="display: none;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>表示名</th>
                                <th>Slack User ID</th>
                                <th>カレンダーID</th>
                                <th>登録日</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="userTableBody">
                            <!-- JavaScriptで動的に追加 -->
                        </tbody>
                    </table>
                </div>
                <div id="emptyState" style="display: none;" class="text-center text-muted py-4">
                    <i class="bi bi-inbox" style="font-size: 3rem;"></i>
                    <p>登録済みユーザーはいません</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 環境に応じてAPI URLを自動設定
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:3000/api'
            : '/api';

        // ページ読み込み時
        document.addEventListener('DOMContentLoaded', () => {
            loadUsers();
        });

        // ユーザー一覧を読み込み
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/calendar/settings`);
                const result = await response.json();

                document.getElementById('loading').style.display = 'none';

                if (result.success && result.data.length > 0) {
                    document.getElementById('userList').style.display = 'block';
                    document.getElementById('emptyState').style.display = 'none';

                    const tbody = document.getElementById('userTableBody');
                    tbody.innerHTML = '';

                    result.data.forEach(user => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.display_name || '-'}</td>
                            <td><code>${user.slack_user_id}</code></td>
                            <td>${user.calendar_id}</td>
                            <td>${new Date(user.created_at).toLocaleDateString('ja-JP')}</td>
                            <td>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.slack_user_id}')">
                                    <i class="bi bi-trash"></i> 削除
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    document.getElementById('userList').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                }
            } catch (error) {
                console.error('ユーザー読み込みエラー:', error);
                alert('ユーザー一覧の読み込みに失敗しました');
            }
        }

        // ユーザー登録
        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const slackUserId = document.getElementById('slackUserId').value.trim();
            const calendarId = document.getElementById('calendarId').value.trim();
            const displayName = document.getElementById('displayName').value.trim();

            try {
                const response = await fetch(`${API_URL}/calendar/settings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        slackUserId,
                        calendarId,
                        displayName: displayName || null
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('カレンダー設定を保存しました！');
                    document.getElementById('addUserForm').reset();
                    loadUsers();
                } else {
                    alert(`エラー: ${result.error}`);
                }
            } catch (error) {
                console.error('保存エラー:', error);
                alert('保存に失敗しました');
            }
        });

        // ユーザー削除
        async function deleteUser(slackUserId) {
            if (!confirm(`ユーザー ${slackUserId} のカレンダー設定を削除しますか？`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/calendar/settings/${slackUserId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('削除しました');
                    loadUsers();
                } else {
                    alert(`エラー: ${result.error}`);
                }
            } catch (error) {
                console.error('削除エラー:', error);
                alert('削除に失敗しました');
            }
        }
    </script>
</body>
</html>
