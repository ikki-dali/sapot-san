# Task 6: 期限管理機能の設計 - 実装状況 🚧

**現在の状況**: バックエンド実装完了、Slack設定待ち
**完了日**: 2025-10-28（バックエンド部分）
**進捗**: 4/6 項目完了（67%）

---

## ✅ 完了した項目

### 1. モーダルUIの設計（Block Kit使用）
- ✅ `app.js`にグローバルショートカットハンドラーを実装
- ✅ 5つの入力フィールドを含むモーダルUI:
  - タスク内容（multiline text input）
  - 担当者（users_select）
  - 期限日（datepicker）
  - 期限時刻（timepicker）
  - 通知先チャンネル（channels_select）

**実装箇所**: app.js:148-259

### 2. モーダル送信ハンドラーの実装
- ✅ `app.view('task_modal_submit')`ハンドラーを実装
- ✅ フォーム値の取得と検証
- ✅ 日本時間（JST, +09:00）での期限日時処理
- ✅ データベースへのタスク保存
- ✅ Slackチャンネルへの通知

**実装箇所**: app.js:265-324

### 3. 期限付きタスク作成機能
- ✅ `taskService.createTask()`で期限（dueDate）をサポート
- ✅ 手動作成タスクには`manual_${Date.now()}`のmessage_tsを使用
- ✅ 期限がない場合は`null`を設定

### 4. `/task-list`コマンドへの期限表示追加
- ✅ 期限がある場合は日本時間で表示
- ✅ 年月日時刻を含む詳細表示

**実装箇所**: app.js:84-94

### 5. テストスクリプトの作成
- ✅ `test-deadline-feature.js`を作成
- ✅ 期限付き/期限なしタスクの作成テスト
- ✅ 24時間以内の期限タスク取得テスト
- ✅ 全テスト成功を確認

### 6. Slack設定ガイドの作成
- ✅ `docs/SLACK-SHORTCUT-SETUP.md`を作成
- ✅ ステップバイステップの設定手順
- ✅ トラブルシューティング情報

---

## ⏸️ 未完了（ユーザー手動設定が必要）

### 1. Slackアプリにグローバルショートカットを追加

**手順**:
1. https://api.slack.com/apps にアクセス
2. 「サポ田さん」アプリを選択
3. **Interactivity & Shortcuts** → **Create New Shortcut**
4. **Global Shortcut** を選択
5. 以下を入力:
   - Name: `Create Task with Deadline`
   - Short Description: `期限付きタスクを作成`
   - Callback ID: `create_task_modal`
6. Save Changes

**詳細**: [Slackショートカット設定ガイド](./SLACK-SHORTCUT-SETUP.md) を参照

### 2. 動作テスト（Slack UI）

**テスト手順**:
1. アプリを起動: `npm start`
2. Slackで⚡アイコンをクリック
3. 「Create Task with Deadline」を選択
4. モーダルでタスクを作成:
   - タスク内容: 「テストタスク」
   - 担当者: 自分
   - 期限日: 明日
   - 期限時刻: 15:00
   - チャンネル: テストチャンネル
5. 「作成」ボタンをクリック
6. チャンネルに通知が投稿されることを確認
7. `/task-list`で期限が表示されることを確認

---

## 📁 作成・更新したファイル

### ソースコード
- `app.js` - グローバルショートカットとモーダルハンドラーを追加（+179行）
- 既存の`src/services/taskService.js` - 期限対応済み（変更なし）

### ドキュメント
- `docs/SLACK-SHORTCUT-SETUP.md` - Slack設定ガイド（新規）
- `docs/task-06-deadline-management.md` - チェックリスト更新
- `docs/README.md` - Phase 2の進捗更新
- `docs/TASK6-STATUS.md` - 本ファイル（新規）

### テストスクリプト
- `test-deadline-feature.js` - 期限機能テスト（新規）

---

## 🎯 実装した機能

### モーダルUI
```
┌─────────────────────────────────────┐
│ タスク作成                           │
├─────────────────────────────────────┤
│ タスク内容:                         │
│ [テキスト入力エリア]                 │
│                                     │
│ 担当者:                             │
│ [ユーザー選択]                       │
│                                     │
│ 期限日:（任意）                      │
│ [日付ピッカー]                       │
│                                     │
│ 期限時刻:（任意）                    │
│ [時刻ピッカー]                       │
│                                     │
│ 通知先チャンネル:                    │
│ [チャンネル選択]                     │
│                                     │
│     [キャンセル]    [作成]           │
└─────────────────────────────────────┘
```

### タスク通知例
```
✅ タスクを作成しました！

タスクID: task_1234567890
内容: 資料を作成する
担当: @user
期限: 2025年10月29日 15:00
```

### タスク一覧表示例
```
📋 現在のタスク一覧

• task_1234567890: 資料を作成する
  担当: @user | 作成日: 2025/10/28
  期限: 2025年10月29日 15:00

• task_0987654321: 別のタスク
  担当: @user | 作成日: 2025/10/27
```

---

## 🔍 テスト結果

### バックエンドテスト（✅ 成功）

```bash
$ node test-deadline-feature.js

🧪 期限管理機能のテスト開始

1️⃣ 期限付きタスクの作成テスト
✅ 期限付きタスク作成成功: task_1761645762680
   期限: 2025/10/29 15:00:00

2️⃣ 期限なしタスクの作成テスト
✅ 期限なしタスク作成成功: task_1761645763252
   期限: なし

3️⃣ タスク一覧取得テスト
✅ 未完了タスク数: 2件

4️⃣ 期限が近いタスクの取得テスト（24時間以内）
✅ 24時間以内に期限のタスク: 1件
   - task_1761645762680
     期限まであと 20 時間

5️⃣ テストタスクのクリーンアップ
✅ 削除完了

✅ 全テスト完了！
```

### Slack UIテスト（⏸️ 未実施）
- ユーザーがSlack設定を完了後に実施可能

---

## 📊 Before / After

### Before（Phase 1完了時点）
- ✅ リアクション（✅/📝）でタスク作成
- ❌ 期限設定ができない
- ❌ 担当者を手動で指定できない
- ❌ モーダルUIなし

### After（Task 6実装後）
- ✅ リアクション（✅/📝）でタスク作成
- ✅ モーダルUIで期限付きタスク作成
- ✅ 担当者を手動で選択可能
- ✅ 期限日・期限時刻を個別設定
- ✅ `/task-list`で期限を確認可能

---

## 🚀 次のステップ

### 1. ユーザーが実施すること

1. **Slack設定を完了**
   - [Slackショートカット設定ガイド](./SLACK-SHORTCUT-SETUP.md)に従って設定
   - Global Shortcut「Create Task with Deadline」を追加

2. **動作確認**
   ```bash
   npm start
   ```
   - Slackで⚡アイコンからショートカットを実行
   - モーダルでタスクを作成
   - チャンネルに通知が投稿されることを確認
   - `/task-list`で期限表示を確認

3. **Task 6完了を確認したら、Task 7へ進む**
   - [タスク7: リマインダーサービスの実装](./task-07-reminder-service.md)
   - 期限が近いタスクを自動通知する機能

### 2. Claude Codeが実施すること（Task 6完了後）

- Task 7（リマインダーサービス）の実装
- `node-cron`を使った定期実行
- 期限切れ・期限近タスクの自動通知

---

## ⚠️ 注意事項

### タイムゾーン
- データベースには**UTC**で保存
- 表示時は**JST（Asia/Tokyo）**に変換
- `TIMESTAMP WITH TIME ZONE`型を使用

### 手動作成のmessage_ts
- リアクションからの作成: 実際のSlackメッセージTS
- モーダルからの作成: `manual_${Date.now()}`

### モーダルの制約
- 最大3000文字まで
- `ack()`は3秒以内に必須
- Optional項目は`optional: true`を設定

---

**📝 現在の状況**: バックエンド実装完了。Slack設定を完了すれば、Task 6は完了します！

**⏭️  次のアクション**: [Slackショートカット設定ガイド](./SLACK-SHORTCUT-SETUP.md)を参照してSlack側の設定を完了してください。
